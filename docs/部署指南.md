# XXXX协会科学技术奖评审管理系统 - 完整部署指南

## 目录

1. [系统要求](#系统要求)
2. [开发环境部署](#开发环境部署)
3. [生产环境部署](#生产环境部署)
4. [数据库配置](#数据库配置)
5. [常见问题](#常见问题)
6. [维护与备份](#维护与备份)

---

## 系统要求

### 最低配置
- CPU: 2核
- 内存: 4GB
- 磁盘: 20GB
- 操作系统: Windows 10+, Ubuntu 18.04+, CentOS 7+

### 推荐配置
- CPU: 4核+
- 内存: 8GB+
- 磁盘: 50GB+ SSD
- 操作系统: Ubuntu 20.04+, CentOS 8+

### 软件依赖
- Python 3.8+
- Node.js 16+ / npm 8+
- MySQL 5.7+ 或 MySQL 8.0+
- Nginx 1.18+ (生产环境)

---

## 开发环境部署

### 第一步: 环境准备

#### 1.1 安装Python

**Windows:**
1. 下载Python 3.8+ from https://www.python.org/downloads/
2. 安装时勾选 "Add Python to PATH"
3. 验证安装:
```bash
python --version
pip --version
```

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install python3.8 python3-pip
```

**CentOS/RHEL:**
```bash
sudo yum install python38 python38-pip
```

#### 1.2 安装Node.js

**Windows:**
1. 下载 Node.js from https://nodejs.org/
2. 安装 LTS 版本
3. 验证:
```bash
node --version
npm --version
```

**Ubuntu/Debian:**
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

**CentOS/RHEL:**
```bash
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install nodejs
```

#### 1.3 安装MySQL

**Windows:**
1. 下载 MySQL Installer from https://dev.mysql.com/downloads/installer/
2. 安装 MySQL Server
3. 记住 root 密码

**Ubuntu/Debian:**
```bash
sudo apt install mysql-server
sudo mysql_secure_installation
```

**CentOS/RHEL:**
```bash
sudo yum install mysql-server
sudo systemctl start mysqld
sudo mysql_secure_installation
```

### 第二步: 项目配置

#### 2.1 克隆/下载项目

```bash
cd /path/to/workspace
# 项目已在: E:\qoder\评奖管理系统
```

#### 2.2 后端配置

```bash
cd backend

# 创建虚拟环境(推荐)
python -m venv venv

# 激活虚拟环境
# Windows:
venv\Scripts\activate
# Linux/macOS:
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

#### 2.3 配置数据库信息

编辑 `backend/config.py`:

```python
class Settings(BaseSettings):
    # 数据库配置
    DB_HOST: str = "localhost"
    DB_PORT: int = 3306
    DB_USER: str = "root"
    DB_PASSWORD: str = "你的MySQL密码"
    DB_NAME: str = "nonferrous_award_system"
    
    # JWT密钥(生产环境务必修改!)
    SECRET_KEY: str = "your-secret-key-change-in-production"
```

#### 2.4 初始化数据库

```bash
cd backend
python setup_database.py
```

执行成功后会看到:
```
✓ 数据库 'nonferrous_award_system' 创建成功
✓ 数据库表创建成功
✓ 创建了 5 个组织
✓ 创建了 8 个用户
...
✓ 演示数据创建完成!
```

#### 2.5 前端配置

```bash
cd frontend

# 安装依赖
npm install

# 如果npm速度慢,可使用淘宝镜像:
npm config set registry https://registry.npmmirror.com
npm install
```

### 第三步: 启动服务

#### 方式一: 使用启动脚本(推荐)

**Windows:**
```bash
cd deploy
start_all.bat
```

**Linux/macOS:**
```bash
cd deploy
chmod +x start_all.sh
./start_all.sh
```

#### 方式二: 手动启动

**启动后端:**
```bash
cd backend
python main.py
```

输出:
```
INFO:     Started server process [xxxx]
INFO:     Uvicorn running on http://0.0.0.0:8000
```

**启动前端:**
```bash
cd frontend
npm run dev
```

输出:
```
  VITE v5.0.0  ready in 500 ms
  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
```

### 第四步: 访问系统

1. **前端页面:** http://localhost:5173
2. **后端API文档:** http://localhost:8000/docs
3. **后端ReDoc:** http://localhost:8000/redoc

使用默认账号登录:
- 管理员: admin / admin123
- 专家: expert01 / expert123
- 申报人: applicant01 / app123

---

## 生产环境部署

### 第一步: 服务器准备

#### 1.1 创建部署用户

```bash
sudo adduser nonferrous
sudo usermod -aG sudo nonferrous
su - nonferrous
```

#### 1.2 安装依赖

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.8 python3-pip python3-venv nginx supervisor mysql-server nodejs npm git

# CentOS
sudo yum install python38 python38-pip nginx supervisor mysql-server nodejs npm git
```

### 第二步: 部署后端

#### 2.1 上传代码

```bash
# 创建项目目录
sudo mkdir -p /var/www/nonferrous-award
sudo chown nonferrous:nonferrous /var/www/nonferrous-award

# 上传代码到 /var/www/nonferrous-award/
# 或使用git:
cd /var/www/nonferrous-award
git clone <repository-url> .
```

#### 2.2 安装后端依赖

```bash
cd /var/www/nonferrous-award/backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 安装Gunicorn
pip install gunicorn
```

#### 2.3 配置环境变量

创建 `.env` 文件:

```bash
cd /var/www/nonferrous-award/backend
nano .env
```

内容:
```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=award_user
DB_PASSWORD=strong_password_here
DB_NAME=nonferrous_award_system
SECRET_KEY=change-this-to-a-random-secret-key
DEBUG=False
```

#### 2.4 初始化数据库

```bash
# 创建数据库用户(在MySQL中执行)
mysql -u root -p

CREATE DATABASE nonferrous_award_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'award_user'@'localhost' IDENTIFIED BY 'strong_password_here';
GRANT ALL PRIVILEGES ON nonferrous_award_system.* TO 'award_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 初始化数据
cd /var/www/nonferrous-award/backend
source venv/bin/activate
python setup_database.py
```

#### 2.5 配置Supervisor

创建配置文件:

```bash
sudo nano /etc/supervisor/conf.d/nonferrous_award.conf
```

内容:
```ini
[program:nonferrous_award_backend]
directory=/var/www/nonferrous-award/backend
command=/var/www/nonferrous-award/backend/venv/bin/gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
autostart=true
autorestart=true
user=nonferrous
stderr_logfile=/var/log/nonferrous_award_backend.err.log
stdout_logfile=/var/log/nonferrous_award_backend.out.log
```

启动服务:
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start nonferrous_award_backend
sudo supervisorctl status
```

### 第三步: 部署前端

#### 3.1 构建前端

```bash
cd /var/www/nonferrous-award/frontend

# 安装依赖
npm install

# 构建生产版本
npm run build
```

构建完成后,静态文件在 `dist/` 目录。

#### 3.2 配置Nginx

创建配置文件:

```bash
sudo nano /etc/nginx/sites-available/nonferrous-award
```

内容:
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名

    # 前端静态文件
    location / {
        root /var/www/nonferrous-award/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API文档
    location /docs {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
    }

    location /redoc {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
    }

    # 文件上传/下载
    location /uploads {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        client_max_body_size 50M;
    }
}
```

启用站点:
```bash
sudo ln -s /etc/nginx/sites-available/nonferrous-award /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 第四步: 配置HTTPS (可选但推荐)

使用Let's Encrypt免费SSL证书:

```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

### 第五步: 配置防火墙

```bash
# Ubuntu (UFW)
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

---

## 数据库配置

### 性能优化

编辑MySQL配置文件 `/etc/mysql/my.cnf`:

```ini
[mysqld]
max_connections = 200
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
```

重启MySQL:
```bash
sudo systemctl restart mysql
```

### 备份策略

#### 自动备份脚本

创建 `/var/www/nonferrous-award/backup_db.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/nonferrous_award"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

mysqldump -u award_user -p'strong_password_here' nonferrous_award_system > $BACKUP_DIR/backup_$DATE.sql
gzip $BACKUP_DIR/backup_$DATE.sql

# 只保留最近7天的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete
```

添加定时任务:
```bash
chmod +x /var/www/nonferrous-award/backup_db.sh
crontab -e

# 每天凌晨2点备份
0 2 * * * /var/www/nonferrous-award/backup_db.sh
```

---

## 常见问题

### 1. 后端无法启动

**问题:** ModuleNotFoundError

**解决:**
```bash
cd backend
source venv/bin/activate
pip install -r requirements.txt
```

### 2. 数据库连接失败

**问题:** Can't connect to MySQL server

**解决:**
- 检查MySQL服务是否启动: `sudo systemctl status mysql`
- 检查配置文件中的数据库信息
- 检查数据库用户权限

### 3. 前端页面空白

**问题:** 页面显示空白

**解决:**
- 检查浏览器控制台错误
- 检查后端API是否正常运行
- 检查Nginx配置中的proxy_pass地址

### 4. 文件上传失败

**问题:** 413 Request Entity Too Large

**解决:**
编辑Nginx配置,增加:
```nginx
client_max_body_size 50M;
```

### 5. 权限问题

**问题:** Permission denied

**解决:**
```bash
sudo chown -R nonferrous:nonferrous /var/www/nonferrous-award
sudo chmod -R 755 /var/www/nonferrous-award
sudo chmod -R 777 /var/www/nonferrous-award/backend/uploads
```

---

## 维护与备份

### 日志查看

**后端日志:**
```bash
sudo tail -f /var/log/nonferrous_award_backend.out.log
sudo tail -f /var/log/nonferrous_award_backend.err.log
```

**Nginx日志:**
```bash
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 更新部署

```bash
# 停止服务
sudo supervisorctl stop nonferrous_award_backend

# 更新代码
cd /var/www/nonferrous-award
git pull

# 更新后端依赖
cd backend
source venv/bin/activate
pip install -r requirements.txt

# 重新构建前端
cd ../frontend
npm install
npm run build

# 重启服务
sudo supervisorctl start nonferrous_award_backend
sudo systemctl reload nginx
```

### 数据库迁移

如需更新数据库结构:

```bash
cd /var/www/nonferrous-award/backend
source venv/bin/activate

# 备份数据库
mysqldump -u award_user -p nonferrous_award_system > backup_before_migration.sql

# 执行迁移脚本(如有)
python migration_script.py
```

### 监控

推荐使用:
- **系统监控:** htop, glances
- **日志监控:** logwatch
- **应用监控:** PM2, New Relic
- **数据库监控:** MySQLTuner

---

## 安全建议

1. **修改默认密码:** 登录后立即修改所有默认用户密码
2. **定期更新:** 定期更新系统和依赖包
3. **防火墙:** 只开放必要端口
4. **SSL/TLS:** 使用HTTPS加密传输
5. **备份:** 定期备份数据库和重要文件
6. **日志审计:** 定期检查访问日志
7. **密钥管理:** 妥善保管SECRET_KEY和数据库密码

---

## 技术支持

如遇到问题,请检查:
1. 后端日志文件
2. Nginx错误日志
3. 浏览器控制台
4. API文档 (http://your-domain/docs)

---

**XXXX协会科学技术奖评审管理系统** 部署指南 v1.0.0

祝部署顺利!
